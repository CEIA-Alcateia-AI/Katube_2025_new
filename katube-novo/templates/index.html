{% extends "base.html" %}

{% block title %}YouTube Audio Pipeline{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h2>
            <i class="fab fa-youtube text-red"></i>
            YouTube Audio Pipeline
        </h2>
        <p class="subtitle">
            Processamento automático de canais completos OU vídeos individuais do YouTube com IA
        </p>
    </div>



    <!-- Formulário Principal -->
    <div class="form-section">
        <form id="processForm" class="process-form">
            <!-- Channel URL Input -->
            <div class="form-group">
                <label for="channelUrl">
                    <i class="fas fa-tv"></i>
                    URL do Canal (Opcional)
                </label>
                <input 
                    type="text" 
                    id="channelUrl" 
                    name="channelUrl" 
                    placeholder="https://www.youtube.com/@canal..." 
                    class="form-input"
                >
                <small class="form-help">Cole a URL do canal para processar todos os vídeos automaticamente</small>
            </div>
            
            <!-- URL Input -->
            <div class="form-group">
                <label for="url">
                    <i class="fas fa-link"></i>
                    URL do Vídeo (Opcional)
                </label>
                <input 
                    type="url" 
                    id="url" 
                    name="url" 
                    placeholder="https://www.youtube.com/watch?v=..." 
                    class="form-input"
                >
                <small class="form-help">Para processar apenas um vídeo específico</small>
            </div>
            
            <!-- Info Box -->
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <p><strong>Escolha uma opção:</strong> Insira a URL do canal para processar todos os vídeos OU a URL de um vídeo específico para processamento individual.</p>
            </div>

            <!-- Configurações Avançadas -->
            <div class="advanced-options">
                <button type="button" class="toggle-advanced" onclick="toggleAdvanced()">
                    <i class="fas fa-cog"></i>
                    Configurações Avançadas
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>
                
                <div id="advancedOptions" class="advanced-content hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filename">
                                <i class="fas fa-file-audio"></i>
                                Nome do Arquivo
                            </label>
                            <input 
                                type="text" 
                                id="filename" 
                                name="filename" 
                                placeholder="nome_personalizado"
                                class="form-input"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="session_name">
                                <i class="fas fa-folder"></i>
                                Nome da Sessão
                            </label>
                            <input 
                                type="text" 
                                id="session_name" 
                                name="session_name" 
                                placeholder="minha_sessao"
                                class="form-input"
                            >
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="num_speakers">
                                <i class="fas fa-users"></i>
                                Número de Locutores (opcional)
                            </label>
                            <input 
                                type="number" 
                                id="num_speakers" 
                                name="num_speakers" 
                                min="1" 
                                max="10"
                                placeholder="Auto"
                                class="form-input"
                            >
                            <small class="form-help">Deixe vazio para detecção automática</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="mos_threshold">
                                <i class="fas fa-star"></i>
                                Limiar MOS (Qualidade)
                            </label>
                            <input 
                                type="number" 
                                id="mos_threshold" 
                                name="mos_threshold" 
                                min="1.0" 
                                max="5.0" 
                                step="0.1"
                                value="2.0"
                                class="form-input"
                            >
                            <small class="form-help">Nota mínima para aceitar áudio (1-5)</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="info-label">
                                <i class="fas fa-filter"></i>
                                Filtro de Qualidade MOS (OBRIGATÓRIO)
                            </label>
                            <small class="form-help">Filtro MOS é sempre habilitado - filtra áudios de baixa qualidade automaticamente</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="min_duration">
                                <i class="fas fa-clock"></i>
                                Duração Mín. Segmento (s)
                            </label>
                            <input 
                                type="number" 
                                id="min_duration" 
                                name="min_duration" 
                                value="10.0"
                                step="0.5"
                                min="5.0"
                                max="30.0"
                                class="form-input"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="max_duration">
                                <i class="fas fa-clock"></i>
                                Duração Máx. Segmento (s)
                            </label>
                            <input 
                                type="number" 
                                id="max_duration" 
                                name="max_duration" 
                                value="15.0"
                                step="0.5"
                                min="10.0"
                                max="60.0"
                                class="form-input"
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enhance_audio" name="enhance_audio" checked>
                                <span class="checkmark"></span>
                                <i class="fas fa-volume-up"></i>
                                Melhorar qualidade do áudio
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="intelligent_segmentation" name="intelligent_segmentation" checked>
                                <span class="checkmark"></span>
                                <i class="fas fa-brain"></i>
                                Segmentação inteligente
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão de Processar -->
            <button type="submit" class="btn-process" id="processBtn">
                <i class="fas fa-play"></i>
                Processar Áudio
            </button>
        </form>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="progress-section hidden">
        <div class="progress-container">
            <h3 id="progressTitle">Processando...</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p id="progressMessage" class="progress-message">Iniciando...</p>
            <div class="progress-details">
                <span id="progressPercent">0%</span>
                <span id="progressTime"></span>
            </div>
        </div>
        
        <div class="progress-steps">
            <div class="step" data-step="waiting">
                <i class="fas fa-hourglass-start"></i>
                <span>Aguardando</span>
            </div>
            <div class="step" data-step="downloading">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </div>
            <div class="step" data-step="normalizing">
                <i class="fas fa-volume-up"></i>
                <span>Normalização</span>
            </div>
            <div class="step" data-step="segmenting">
                <i class="fas fa-cut"></i>
                <span>Segmentação</span>
            </div>
            <div class="step" data-step="filtering">
                <i class="fas fa-filter"></i>
                <span>Filtro MOS</span>
            </div>
            <div class="step" data-step="diarizing">
                <i class="fas fa-users"></i>
                <span>Diarização</span>
            </div>
            <div class="step" data-step="overlap">
                <i class="fas fa-search"></i>
                <span>Overlap</span>
            </div>
            <div class="step" data-step="separating">
                <i class="fas fa-divide"></i>
                <span>Separação</span>
            </div>
            <div class="step" data-step="preparing">
                <i class="fas fa-microphone"></i>
                <span>Prep. STT</span>
            </div>
            <div class="step" data-step="transcribing">
                <i class="fas fa-file-alt"></i>
                <span>STT + Validação</span>
            </div>
            <div class="step" data-step="denoising">
                <i class="fas fa-magic"></i>
                <span>Denoiser</span>
            </div>
            <div class="step" data-step="completed">
                <i class="fas fa-check"></i>
                <span>Concluído</span>
            </div>
            <div class="step" data-step="denoising">
                <i class="fas fa-magic"></i>
                <span>Denoiser</span>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="error-section hidden">
        <div class="error-container">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Erro no Processamento</h3>
            <p id="errorMessage"></p>
            <button onclick="resetForm()" class="btn-secondary">
                <i class="fas fa-redo"></i>
                Tentar Novamente
            </button>
        </div>
    </div>

<<<<<<< HEAD
    <!-- Features Section -->
    <div class="features-section">
        <h3>Recursos da Pipeline</h3>
        <div class="features-grid">
            <div class="feature-card">
                <i class="fab fa-youtube"></i>
                <h4>Download Direto</h4>
                <p>Baixa áudio em FLAC com máxima qualidade diretamente do YouTube</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-cut"></i>
                <h4>Segmentação Inteligente</h4>
                <p>Divide o áudio respeitando pausas naturais e evitando corte de palavras</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-users"></i>
                <h4>Diarização de Locutores</h4>
                <p>Identifica e separa diferentes locutores usando IA state-of-the-art</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-search"></i>
                <h4>Detecção de Sobreposição</h4>
                <p>Identifica trechos com vozes sobrepostas para melhor qualidade</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-microphone"></i>
                <h4>Preparação STT</h4>
                <p>Organiza arquivos finais prontos para transcrição Speech-to-Text</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-download"></i>
                <h4>Downloads Organizados</h4>
                <p>Baixe os resultados organizados por locutor e prontos para uso</p>
            </div>
            <div class="feature-card">
                <i class="fas fa-podcast"></i>
                <h4>Removedor de Ruído</h4>
                <p>Aplica um denoiser nos áudios segmentados, diminuindo ruídos de fundo</p>
            </div>
        </div>
    </div>
=======
     <!-- Features Section -->
     <div class="features-section">
         <h3>Recursos da Pipeline</h3>
         <div class="features-grid">
             <div class="feature-card">
                 <i class="fab fa-youtube"></i>
                 <h4>Download Direto</h4>
                 <p>Baixa áudio em FLAC com máxima qualidade diretamente do YouTube</p>
                 <div class="feature-tools">
                     <span class="tool-tag">YT-DLP</span>
                     <span class="tool-tag">FLAC</span>
                     <span class="tool-tag">24KHZ</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-volume-up"></i>
                 <h4>Normalização de Áudio</h4>
                 <p>Normaliza áudio para FLAC 24kHz Mono usando FFmpeg</p>
                 <div class="feature-tools">
                     <span class="tool-tag">FFMPEG</span>
                     <span class="tool-tag">24KHZ</span>
                     <span class="tool-tag">MONO</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-cut"></i>
                 <h4>Segmentação Inteligente</h4>
                 <p>Divide o áudio respeitando pausas naturais e evitando corte de palavra com VAD</p>
                 <div class="feature-tools">
                     <span class="tool-tag">VAD</span>
                     <span class="tool-tag">LIBROSA</span>
                     <span class="tool-tag">SCIPY</span>
                     <span class="tool-tag">WEBRTC</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-filter"></i>
                 <h4>Filtro de Qualidade MOS</h4>
                 <p>Classificação de MOS em 3 niveis: Aprovados (≥3.0), Intermediários (2.5-3.0), Rejeitados (<2.5)</p>
                 <div class="feature-tools">
                     <span class="tool-tag">SHEET</span>
                     <span class="tool-tag">MOS-BENCH</span>
                     <span class="tool-tag">3-TIER</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-users"></i>
                 <h4>Diarização de Locutores</h4>
                 <p>Identifica e separa diferentes locutores pyannote.audio 3.1</p>
                 <div class="feature-tools">
                     <span class="tool-tag">PYANNOTE.AUDIO</span>
                     <span class="tool-tag">HUGGING FACE</span>
                     <span class="tool-tag">TRANSFORMERS</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-search"></i>
                 <h4>Detecção de Sobreposição (OSD)</h4>
                 <p>Identifica trechos com vozes sobrepostas usando pyannote/segmentation-3.0 e overlap speech detection</p>
                 <div class="feature-tools">
                     <span class="tool-tag">PYANNOTE.AUDIO</span>
                     <span class="tool-tag">SEGMENTATION-3.0</span>
                     <span class="tool-tag">OSD</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-divide"></i>
                 <h4>Separação por Locutor</h4>
                 <p>Separa áudio por locutor criando arquivos individuais com rttm</p>
                 <div class="feature-tools">
                     <span class="tool-tag">SPEAKER SEPARATION</span>
                     <span class="tool-tag">RTTM</span>
                     <span class="tool-tag">SOUNDFILE</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-file-alt"></i>
                 <h4>STT Dual</h4>
                 <p>Transcrição com Whisper e WAV2VEC2</p>
                 <div class="feature-tools">
                     <span class="tool-tag">DISTIL-WHISPER</span>
                     <span class="tool-tag">WAV2VEC2-CORAA</span>
                     <span class="tool-tag">HUGGING FACE</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-check-circle"></i>
                 <h4>Validação Levenshtein</h4>
                 <p>Validação de similaridade entre transcrições com threshold 85%</p>
                 <div class="feature-tools">
                     <span class="tool-tag">LEVENSHTEIN</span>
                     <span class="tool-tag">TEXTDISTANCE</span>
                     <span class="tool-tag">80%</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-magic"></i>
                 <h4>Denoiser</h4>
                 <p>Remove ruído dos áudios validados usando DeepFilterNet3</p>
                 <div class="feature-tools">
                     <span class="tool-tag">DEEPFILTERNET3</span>
                     <span class="tool-tag">AI DENOISING</span>
                     <span class="tool-tag">PYTORCH</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-volume-up"></i>
                 <h4>Normalização</h4>
                 <p>Normalização final com Sox para padronização de qualidade</p>
                 <div class="feature-tools">
                     <span class="tool-tag">SOX</span>
                     <span class="tool-tag">NORMALIZE</span>
                     <span class="tool-tag">GAIN</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-database"></i>
                 <h4>Dataset Final</h4>
                 <p>Áudios processados e salvos em dataset estruturado com nomenclatura padronizada</p>
                 <div class="feature-tools">
                     <span class="tool-tag">FLAC</span>
                     <span class="tool-tag">48KHZ</span>
                     <span class="tool-tag">STRUCTURED</span>
                     <span class="tool-tag">MONO</span>
                 </div>
             </div>
         </div>
     </div>
>>>>>>> main
</div>
{% endblock %}

{% block scripts %}
<script>
let currentJobId = null;
let progressInterval = null;

function toggleAdvanced() {
    const options = document.getElementById('advancedOptions');
    const icon = document.querySelector('.toggle-icon');
    
    if (options.classList.contains('hidden')) {
        options.classList.remove('hidden');
        icon.classList.add('rotated');
    } else {
        options.classList.add('hidden');
        icon.classList.remove('rotated');
    }
}

function showProgress() {
    document.getElementById('progressSection').classList.remove('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '0.7';
    document.getElementById('processBtn').disabled = true;
}

function hideProgress() {
    document.getElementById('progressSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '1';
    document.getElementById('processBtn').disabled = false;
}

function showError(message) {
    document.getElementById('errorSection').classList.remove('hidden');
    document.getElementById('errorMessage').textContent = message;
    hideProgress();
}

function resetForm() {
    document.getElementById('errorSection').classList.add('hidden');
    document.getElementById('progressSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '1';
    document.getElementById('processBtn').disabled = false;
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    
    // Reset progress
    updateProgress('waiting', 0, 'Pronto para processar');
}

function updateProgress(status, progress, message) {
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressPercent').textContent = progress + '%';
    
    // Update steps
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    const currentStep = document.querySelector(`[data-step="${status}"]`);
    if (currentStep) {
        currentStep.classList.add('active');
        
        // Add success animation for completed steps
        if (progress > 0 && status !== 'waiting') {
            setTimeout(() => {
                const icon = currentStep.querySelector('i');
                if (icon && !icon.classList.contains('fa-check-circle')) {
                    icon.className = 'fas fa-check-circle';
                    currentStep.classList.add('success-pulse');
                }
            }, 500);
        }
    }
    
    // Mark previous steps as completed with green checkmarks
    const steps = ['waiting', 'downloading', 'normalizing', 'segmenting', 'filtering', 'diarizing', 'overlap', 'separating', 'preparing', 'transcribing', 'denoising', 'completed'];
    const currentIndex = steps.indexOf(status);
    
    for (let i = 0; i < currentIndex; i++) {
        const step = document.querySelector(`[data-step="${steps[i]}"]`);
        if (step) {
            step.classList.add('completed');
            step.classList.remove('active');
            
            // Add green checkmark for completed steps
            const icon = step.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-check-circle';
            }
        }
    }
}

function pollJobStatus(jobId) {
    axios.get(`/status/${jobId}`)
        .then(response => {
            const data = response.data;
            updateProgress(data.status, data.progress, data.message);
            
            if (data.status === 'completed') {
                clearInterval(progressInterval);
                setTimeout(() => {
                    window.location.href = `/results/${jobId}`;
                }, 1500);
            } else if (data.status === 'failed') {
                clearInterval(progressInterval);
                showError(data.error || 'Erro desconhecido no processamento');
            }
        })
        .catch(error => {
            console.error('Erro ao verificar status:', error);
            clearInterval(progressInterval);
            showError('Erro de comunicação com o servidor');
        });
}

document.getElementById('processForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Get form data
    for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
            // Convert numeric fields
            if (['num_speakers', 'min_duration', 'max_duration'].includes(key)) {
                data[key] = parseFloat(value);
            } else if (['enhance_audio', 'intelligent_segmentation'].includes(key)) {
                data[key] = true; // Checkbox is checked if present
            } else {
                data[key] = value;
            }
        }
    }
    
    // Handle checkboxes that aren't checked
    if (!formData.has('enhance_audio')) data['enhance_audio'] = false;
    if (!formData.has('intelligent_segmentation')) data['intelligent_segmentation'] = false;
    
    // Validate URLs
    const channelUrl = data.channelUrl;
    const videoUrl = data.url;
    
    // Check if at least one URL is provided
    if ((!channelUrl || channelUrl.trim() === '') && (!videoUrl || videoUrl.trim() === '')) {
        showError('Por favor, insira uma URL do canal OU uma URL de vídeo para processar');
        return;
    }
    
    // Validate channel URL if provided
    if (channelUrl && channelUrl.trim() !== '') {
        if (!isValidYouTubeUrl(channelUrl)) {
            showError('Por favor, insira uma URL válida do canal YouTube (ex: https://www.youtube.com/@canal)');
            return;
        }
    }
    
    // Validate video URL if provided
    if (videoUrl && videoUrl.trim() !== '') {
        if (!isValidYouTubeUrl(videoUrl)) {
            showError('Por favor, insira uma URL válida do vídeo YouTube (ex: https://www.youtube.com/watch?v=...)');
            return;
        }
    }
    
    // Check if both URLs are provided (not recommended)
    if (channelUrl && channelUrl.trim() !== '' && videoUrl && videoUrl.trim() !== '') {
        showError('Por favor, insira apenas uma URL: canal OU vídeo, não ambos');
        return;
    }
    
    showProgress();
    updateProgress('waiting', 0, 'Enviando solicitação...');
    
    // Determine processing type based on input
    let endpoint = '/process';
    let progressMessage = 'Processamento iniciado...';
    
    if (channelUrl && channelUrl.trim() !== '') {
        // Process entire channel
        endpoint = '/process_channel';
        progressMessage = 'Iniciando processamento do canal...';
    } else if (videoUrl && videoUrl.trim() !== '') {
        // Process single video
        endpoint = '/process';
        progressMessage = 'Iniciando processamento do vídeo...';
    }
    
    axios.post(endpoint, data)
        .then(response => {
            currentJobId = response.data.job_id;
            updateProgress('waiting', 5, progressMessage);
            
            // Start polling for status updates
            progressInterval = setInterval(() => {
                pollJobStatus(currentJobId);
            }, 2000);
        })
        .catch(error => {
            const message = error.response?.data?.error || 'Erro ao iniciar processamento';
            showError(message);
        });
});

function isValidYouTubeUrl(url) {
    const patterns = [
        /^https:\/\/www\.youtube\.com\/@[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/channel\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/c\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/user\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/watch\?v=[a-zA-Z0-9_-]+$/,
        /^https:\/\/youtu\.be\/[a-zA-Z0-9_-]+$/
    ];
    
    return patterns.some(pattern => pattern.test(url));
}
</script>
{% endblock %}
